name: Test DevContainer

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'devenv/**'
      - 'common/.devcontainer/**'
      - '.github/workflows/test-devcontainer.yml'

env:
  REGISTRY: ghcr.io

jobs:
  test:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        os: [debian]
        # TODO: c10s has PAM/sudo issues with devcontainer CLI's --userns=keep-id
        # include:
        #   - os: c10s

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up runner
        uses: bootc-dev/actions/bootc-ubuntu-setup@main

      - name: Build devcontainer image
        run: just devenv-build-${{ matrix.os }}

      - name: Create override config for local image
        run: |
          cat > /tmp/devcontainer-override.json << 'EOF'
          {
            "image": "localhost/bootc-devenv-${{ matrix.os }}:latest",
            "runArgs": [
              "--security-opt", "label=disable",
              "--security-opt", "unmask=/proc/*",
              "--device", "/dev/net/tun",
              "--device", "/dev/kvm"
            ],
            "postCreateCommand": {
              "devenv-init": "sudo /usr/local/bin/devenv-init.sh"
            }
          }
          EOF

      - name: Start devcontainer
        run: |
          npx --yes @devcontainers/cli up \
            --workspace-folder . \
            --docker-path podman \
            --override-config /tmp/devcontainer-override.json \
            --remove-existing-container

      - name: Test nested podman in devcontainer
        run: |
          npx @devcontainers/cli exec \
            --workspace-folder . \
            --docker-path podman \
            /usr/libexec/devenv-selftest.sh
