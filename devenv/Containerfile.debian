# These aren't packages, just low-dependency binaries dropped in /usr/local/bin
# so we can fetch them independently in a separate build.
ARG base=docker.io/library/debian:sid
FROM $base as base
# Life is too short to care about dash
RUN ln -sfr /bin/bash /bin/sh
RUN <<EORUN
set -xeuo pipefail

# Disable apt sandboxing for nested container environments
echo 'APT::Sandbox::User "root";' > /etc/apt/apt.conf.d/99sandbox-disable

# Initialize some basic packages
apt -y update && apt -y install curl time bzip2

# Enable deb-src repositories for build-dep
sed -i "s/^deb /deb [arch=$(dpkg --print-architecture)] /" /etc/apt/sources.list.d/debian.sources
sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/debian.sources

# Enable gh CLI repository
mkdir -p -m 755 /etc/apt/keyrings
curl -fLo /etc/apt/keyrings/githubcli-archive-keyring.gpg https://cli.github.com/packages/githubcli-archive-keyring.gpg
chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
mkdir -p -m 755 /etc/apt/sources.list.d
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list

# And re-update after we've fetched repos
apt -y update
EORUN

FROM base as tools
# renovate: datasource=github-releases depName=bootc-dev/bcvk
ARG bcvkversion=v0.9.0
# renovate: datasource=github-releases depName=ossf/scorecard
ARG scorecardversion=v5.1.1
COPY fetch-tools.sh /run/src/
RUN bcvkversion=$bcvkversion scorecardversion=$scorecardversion /run/src/fetch-tools.sh

FROM base as rust
COPY install-rust.sh /run/src/
RUN /run/src/install-rust.sh

# Kani formal verification tool - requires rustup for toolchain management
FROM rust as kani
# renovate: datasource=crate depName=kani-verifier
ARG kaniversion=0.67.0
RUN apt-get update && apt-get install -y --no-install-recommends gcc libc6-dev && rm -rf /var/lib/apt/lists/*
COPY install-kani.sh /run/src/
RUN kaniversion=$kaniversion /run/src/install-kani.sh

# This builds the image.
# Build this using `just devenv-build-debian` from the root of the repository.
FROM base
COPY packages-common.txt packages-debian.txt build-deps-debian.txt /run/src/
WORKDIR /run/src
RUN <<EORUN
set -xeuo pipefail
grep -hEve '^#' packages-common.txt packages-debian.txt | /bin/time -f '%E %C' xargs apt -y install
grep -vEe '^#' build-deps-debian.txt | /bin/time -f '%E %C' xargs apt -y build-dep
apt clean && rm -rf /var/lib/apt/lists/*
EORUN
COPY npm.txt /run/src
RUN grep -vEe '^#' npm.txt | /bin/time -f '%E %C' xargs npm i -g

# Copy in the binaries from our tools container image
COPY --from=tools /usr/local/bin/* /usr/local/bin/
COPY --from=kani /usr/local/bin/* /usr/local/bin/
COPY --from=kani /usr/local/rustup /usr/local/rustup
# Kani bundle (compiler, libraries, CBMC) installed via KANI_HOME during setup
COPY --from=kani /usr/local/kani /usr/local/kani
# Point rustup at the system-wide installation, but let CARGO_HOME default to ~/.cargo
ENV RUSTUP_HOME=/usr/local/rustup
# Point Kani at the system-wide installation
ENV KANI_HOME=/usr/local/kani
# Setup for codespaces
COPY devenv-init.sh /usr/local/bin/
COPY userns-setup /usr/lib/devenv/userns-setup
COPY devenv-selftest.sh /usr/libexec/
RUN chmod 755 /usr/libexec/devenv-selftest.sh /usr/lib/devenv/userns-setup

WORKDIR /
# Create user before declaring volumes so home directory has correct ownership
RUN <<EORUN
set -xeuo pipefail
useradd -m devenv -s /bin/bash
# This needs to be precreated and owned by the devenv user
mkdir -p ~devenv/.local/share/containers
chown -R -h devenv: ~devenv/.local
echo 'devenv ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/devenv && chmod 0440 /etc/sudoers.d/devenv
EORUN
# To avoid overlay-on-overlay with nested containers
VOLUME [ "/var/lib/containers", "/home/devenv/.local/share/containers/" ]
USER devenv
